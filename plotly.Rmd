---
title: "plotly"
output: html_document
code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(viridis)
library(p8105.datasets)
library(plotly)
library(tidyverse)
library(rnoaa)
library(dplyr)
library(lubridate)
library(gganimate)
library(gifski)
library(p8105.datasets)
data("nyc_airbnb")
data("instacart")
data("rest_inspec")

```


```{r, include=FALSE}
#data cleaning
set.seed(1)

data(nyc_airbnb)
nyc_airbnb = 
  nyc_airbnb %>% 
  mutate(rating = review_scores_location / 2) %>%
  select(
    neighbourhood_group, neighbourhood, rating, price, room_type, lat, long) %>%
  filter(
    !is.na(rating), 
    neighbourhood_group == "Manhattan",
    room_type == "Entire home/apt",
    price %in% 100:500)  %>% 
  sample_n(5000)
```

```{r, echo=FALSE, warning = FALSE, include = FALSE}
nyc_airbnb %>% 
  plot_ly(x = ~lat, y = ~long, type = "scatter", mode = "markers",
    color = ~price, alpha = 0.5)
```

```{r, echo=FALSE, warning = FALSE, include = FALSE}
nyc_airbnb %>% 
  mutate(neighbourhood = fct_reorder(neighbourhood, price)) %>% 
  plot_ly(y = ~price, color = ~neighbourhood, type = "box", colors = "Set2")
```

```{r, echo = FALSE, warning = FALSE, include = FALSE}
nyc_airbnb %>% 
  count(neighbourhood) %>% 
  mutate(neighbourhood = fct_reorder(neighbourhood, n)) %>% 
  plot_ly(x = ~neighbourhood, y = ~n, color = ~neighbourhood, type = "bar", colors = "YlGnBu")
```

## Instacart Data Visualization
```{r, echo = FALSE, warning = FALSE, message = FALSE}

instacart %>% 
  group_by(department, order_dow) %>% 
  summarize(count_week = n()) %>%
  ungroup() %>% 
  group_by(department) %>% 
  mutate(prct_week = count_week/sum(count_week)) %>%
  plot_ly(x = ~order_dow, 
          y = ~prct_week, 
          color = ~department,
          type = "scatter",
          mode = "line+markers",
          line = list(shape = 'spline', width= 1.8),
          marker = list(symbol = "star-diamond",size = 3),
          alpha = 0.8,
          colors = "Set1"
          )   %>% 
  layout(
    xaxis = list(
      title = "Order Day of the Week",
      zeroline = F
    ),
    yaxis = list(
      title = "Percentage (%)",
      zeroline = F
    ),
    legend = list(
      orientation = "h"
    )
  )
```

```{r, echo = FALSE, warning = FALSE}
instacart %>%
  filter(department == "alcohol" | department == "dairy eggs") %>% 
  group_by(order_hour_of_day, aisle) %>% 
  mutate(aisle_n = n()) %>%
  select(department, order_hour_of_day, aisle, aisle_n) %>% 
  unique() %>% 
  arrange(aisle, order_hour_of_day) %>% 
  ungroup() %>% 
  group_by(aisle) %>% 
  mutate(aisle_pctn = aisle_n/sum(aisle_n)) %>%
  plot_ly(
    x = ~order_hour_of_day,
    y = ~aisle_pctn,
    alpha = 0.9,
    color = ~department,
    type = "scatter",
    mode = "markers",
    marker = list(symbol = "star-diamond",size = 5),
    colors = c("red", "blue")
  )


```


```{r, echo = FALSE, warning = FALSE}
top_5_alcohol = 
  instacart%>% 
  filter(department == "alcohol") %>% 
  group_by(product_id) %>% 
  mutate(total_n = sum(n())) %>% 
  select(product_id, product_name, total_n) %>% 
  unique() %>% 
  arrange(desc(total_n)) %>% 
  head(6)

instacart %>% 
  filter(product_id %in% c(top_5_alcohol$product_id)) %>% 
  group_by(product_id, order_dow) %>% 
  mutate(n_daily_product = n()) %>% 
  select(product_id, product_name, order_dow, n_daily_product, department, aisle) %>% 
  unique() %>% 
  ungroup() %>% 
  group_by(product_id) %>% 
  arrange(product_name, order_dow) %>% 
  plot_ly(
    x = ~order_dow,
    y = ~n_daily_product,
    type = "scatter",
    mode = "lines+markers",
    color = ~product_name,
    text = ~product_name,
    alpha = 0.8,
    line = list(shape = 'spline', width= 2),
    marker = list(symbol = "star-diamond",size = 5),
    colors = "RdYlBu"
  )  %>% 
  layout(
    xaxis = list(
      title = "Order Day of the week",
      zeroline = F
    ),
    yaxis = list(
      title = "Percentage (%)",
      zeroline = F
    )
  )

```



```{r, echo = FALSE, warning = FALSE}
top_50_icecream = 
  instacart %>% 
  filter(aisle == "ice cream ice") %>% 
  group_by(product_id) %>% 
  mutate(total_n_product = n()) %>% 
  select(product_id, product_name, total_n_product) %>% 
  arrange(desc(total_n_product)) %>% 
  unique() %>% 
  head(50)


instacart %>%
  filter(product_name %in% top_50_icecream$product_name) %>% 
  count(product_name) %>% 
  mutate(
    product_name = fct_reorder(product_name, n)
  ) %>%
  plot_ly(
    x = ~product_name,
    y = ~n,
    color = ~product_name,
    type = "bar",
    colors = "YlOrRd"
  ) %>% 
  layout(
    showlegend = FALSE,
    xaxis = list(
      title = "Best selling 50 ice creams names",
      zeroline = F
    ),
    yaxis = list(
      title = "Frequency",
      zeroline = F
    )
  )

```


## NOAA Data Visualization

```{r, include = FALSE}

# Load the data
load("./nynoaadat.RData")

daily_tmin_tmax = 
  nydat %>% 
  mutate(date = as.character(date)) %>% 
  group_by(date) %>% 
  mutate(
    avg_tmax = mean(tmax, na.rm = TRUE),
    avg_tmin = mean(tmin, na.rm = TRUE)
    ) %>% 
  select(date, avg_tmax, avg_tmin) %>% 
  unique() %>%
  mutate(
    diff_max_min = avg_tmax - avg_tmin,
    month = substr(date, 6, 7),
    year = substr(date, 1, 4)
    )

```

```{r}
boxplot_diff = 
  daily_tmin_tmax %>% 
  group_by(year, month) %>% 
  mutate(month_diff_max_min = mean(diff_max_min)) %>%  
  ungroup() %>% 
  select(year, month, month_diff_max_min) %>% 
  unique() %>% 
  arrange(year, month) %>% 
  mutate(type = ifelse(month %in% c("05","12"), "Highlighted", "Normal")
         ) %>% 
  ggplot(
    aes(
      x = month,
      y = month_diff_max_min,
      fill = type,
      alpha = type
    ))+
  geom_boxplot() + 
  scale_fill_manual(values=c("slategray2", "white")) +
    scale_alpha_manual(values=c(1,0.1)) +
    theme(legend.position = "none") +
    xlab("")+
  theme_classic() +
  labs(
    title = "Temperature Difference plot",
    x = "Month",
    y = "Difference between maximum and minimum temperture",
    caption = "Data from the rnoaa package")

ggplotly(boxplot_diff)
```



```{r, echo = FALSE}
heatmap_794 = 
  nydat %>% 
  filter(id == "USW00094794") %>% 
  mutate(year = year(date),
         month = month(date, label = TRUE),
         day = day(date)) %>% 
  filter(year %in% c(1986, 1996, 2006)) %>% 
  select(id, day, month, year, tmax) %>% 
  ggplot(
    aes(
      x = month,
      y = day,
      fill = tmax
    )
  )+
  geom_tile(
    color = "white",
    size = 0.1
  )+
  scale_y_continuous(breaks =c(1,10,20,31))+
  scale_fill_viridis(name = "Maximum Temperature", option = "C")+
  facet_grid(~year)+
  labs( x="Month", y="Day Commencing")+ theme(legend.position = "bottom")+
  theme(plot.title=element_text(size = 14))+
  theme(axis.text.y=element_text(size=6)) +
  theme(strip.background = element_rect(colour="white"))+
  theme(plot.title=element_text(hjust=0))+
  theme(axis.ticks=element_blank())+
  theme(axis.text=element_text(size=7))+
  theme(legend.title=element_text(size=8))+
  theme(legend.text=element_text(size=6))+
  theme_linedraw()

ggplotly(heatmap_794)

```

```{r}
p = 
nydat %>%
  filter(id %in% c("USC00300331", "USC00300785","USC00304174")) %>% 
  mutate(year = year(date),
         month = month(date, label = TRUE),
         day = day(date)) %>% 
  arrange(date) %>% 
  ggplot(
    aes(
      x = tmin,
      y = tmax,
      size = prcp,
      color = id
    ))+
  geom_point(alpha = 0.7) +
  scale_size(range = c(2,12))+
  theme_bw() + 
  labs(
    title = "Date: {frame_time}",
    x = "Minimum temperature",
    y = "Maximum temperature") +
  transition_time(date) + 
  ease_aes("linear") +
  facet_grid(~id)

animate(p, fps = 2)
```


```{r, include = FALSE}
latest_inspection = 
  rest_inspec %>%
  group_by(dba) %>% 
  arrange(desc(inspection_date)) %>% 
  top_n(1) %>% 
  select(boro, building, camis, cuisine_description, dba, inspection_date, score, grade) %>% 
  unique()

```


```{r}
latest_inspection %>% 
  filter(cuisine_description == "Korean") %>% 
  ggplot(
    aes(
      x = boro,
      y = score,
      fill = boro
    )
  )+
  geom_boxplot()+
  scale_fill_viridis(discrete = TRUE, alpha = 0.6)+
  geom_jitter(color = "black", size = 0.4, alpha = 0.9) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 11)
  ) +
  ggtitle("Korean Restuarant: A boxplot with jitter") +
  xlab("")

```


